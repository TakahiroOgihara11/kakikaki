<div class="user-show-page">
  <img src="<%= asset_path('mypage.png') %>" alt="„Éû„Ç§„Éö„Éº„Ç∏" class="mypage-image">
  <img src="<%= asset_path('book.png') %>" alt="Êú¨" class="book-image">
  <div class="content">

    <!-- „Éí„Éº„É≠„ÉºÔºà„Éû„Ç§„Éö„Éº„Ç∏/„Éó„É≠„Éï„Ç£„Éº„É´Ë¶ãÂá∫„Åó + Áä∂ÊÖãÔºâ -->
    <section class="user-hero">
      <div class="user-hero__top">
        <h1 class="user-hero__heading">
          <%= @user == current_user ? "„Éû„Ç§„Éö„Éº„Ç∏" : "#{@user.name}„Åï„Çì„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´" %>
        </h1>

        <% if current_user == @user %>
          <p class="user-hero__sub">
            <% if @user.tweets.where(created_at: Time.zone.now.all_day).exists? %>
              ‰ªäÊó•„ÅØÊó•Ë®ò„ÇíÊõ∏„Åç„Åæ„Åó„Åü
              <%= image_tag "check_icon.svg", alt: "„ÉÅ„Çß„ÉÉ„ÇØ„Éû„Éº„ÇØ", class: "check-icon" %>
            <% else %>
              ‰ªäÊó•„ÇÇÊó•Ë®ò„ÇíÊõ∏„Åì„ÅÜÔºÅ
            <% end %>
          </p>
        <% end %>
      </div>

      <% if current_user == @user %>
        <div class="user-hero__actions">
          <%= link_to "Êó•Ë®ò„ÇíÊõ∏„Åè", new_tweet_path, class: "btn btn--primary" %>

          <% if @user.tweets.where(created_at: Time.zone.now.all_day).exists? %>
            <%= link_to "„Éï„Ç©„É≠„Éº‰∏≠„ÅÆ‰∫∫„ÅÆÊó•Ë®ò„ÇíË¶ã„Çã", following_posts_tweets_path, class: "btn btn--ghost" %>
          <% else %>
            <span class="btn btn--disabled">„Éï„Ç©„É≠„Éº‰∏≠„ÅÆ‰∫∫„ÅÆÊó•Ë®ò„ÇíË¶ã„ÇãÔºàÊú¨Êó•Êú™ÊäïÁ®øÔºâ</span>
          <% end %>

          <%= link_to "„É¶„Éº„Ç∂„Éº‰∏ÄË¶ß", users_path, class: "btn btn--ghost" %>
          <%= link_to "„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁ∑®ÈõÜ„Åô„Çã", edit_user_registration_path, class: "btn btn--ghost" %>
        </div>
      <% end %>
    </section>

    <!-- 2„Ç´„É©„É†ÔºöÂ∑¶=„Éó„É≠„Éï„Ç£„Éº„É´„ÄÅÂè≥=ÊäïÁ®ø„Éï„Ç£„Éº„ÉâÔºà„Éï„É´ÂπÖ„Ç∞„É™„ÉÉ„ÉâÔºâ -->
    <section class="user-main">
      <aside>
        <!-- „Éó„É≠„Éï„Ç£„Éº„É´„Ç´„Éº„Éâ -->
        <div class="card">
          <div class="profile-card__header">
            <%= image_tag(@user.profile_image.attached? ? @user.profile_image : "default_icon.png",
                          class: "profile-card__avatar") %>
            <div>
              <h2 class="profile-card__name"><%= @user.name %></h2>
              <% if current_user == @user %>
                <p class="profile-card__email"><%= @user.email %></p>
                
              <% end %>
            </div>
          </div>
          <p class="profile-card__bio"><%= @user.profile %></p>
        </div>

        <!-- Âàù„ÇÅ„Å¶„ÅÆÊó•Ë®òÔºàÈñ≤Ë¶ßËÄÖ„Åå‰ªñ‰∫∫„ÅÆ„Éó„É≠„Éï„ÇíË¶ã„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ -->
        <% unless current_user == @user %>
          <div class="card" style="margin-top:12px">
            <h3 class="section-title">Âàù„ÇÅ„Å¶„ÅÆÊó•Ë®ò</h3>
            <div class="recent-list">
              <% @user.tweets.order(created_at: :asc).limit(1).each do |tweet| %>
                <article class="recent-item">
                  <h4 class="recent-item__title"><%= tweet.name %></h4>
                  <p class="recent-item__meta"><%= tweet.created_at.strftime('%Y-%m-%d %H:%M') %></p>
                  <% if tweet.image.attached? %>
                    <%= image_tag tweet.image, class: "recent-item__img clickable-image",
                                   data: { full_image_url: url_for(tweet.image) } %>
                  <% end %>
                  <p>üíó <%= tweet.likes.count %>‰ª∂„ÅÆ„ÅÑ„ÅÑ„Å≠</p>
                </article>
              <% end %>
            </div>
          </div>
        <% end %>
      </aside>

      <!-- ÊäïÁ®ø„Éï„Ç£„Éº„ÉâÔºàÊúÄÊñ∞È†Ü / ÂèØÂ§â„Ç∞„É™„ÉÉ„ÉâÔºâ -->
      <% if current_user == @user %>
        <section class="us-feed">
          <% @user.tweets.order(created_at: :desc).each do |t| %>
          <div class="us-post card">
            <header class="us-post__head">
              <h4 class="post__title"><%= t.name %></h4>
              <p class="post__meta"><%= t.time&.strftime('%Y-%m-%d %H:%M') || t.created_at.strftime('%Y-%m-%d %H:%M') %></p>
            </header>

            <div class="post__body"><%= simple_format(t.diary) %></div>

            <% if t.image.attached? %>
              <div class="us-image">
                <%= image_tag t.image, class: "post__img clickable-image",
                              data: { full_image_url: url_for(t.image) } %>
              </div>
            <% end %>

            <footer class="us-post__foot">
              <p class="us-like">üíó <%= t.likes.count %>‰ª∂„ÅÆ„ÅÑ„ÅÑ„Å≠</p>

              <% c = t.comments.size %>
              <button type="button"
                      class="us-comments__toggle"
                      data-target="us-comments-<%= t.id %>"
                      aria-expanded="false"
                      aria-controls="us-comments-<%= t.id %>">
                „Ç≥„É°„É≥„Éà„ÇíË°®Á§∫ <span class="us-count"><%= c %></span>
              </button>
            </footer>

            <!-- „Ç≥„É°„É≥„ÉàÔºàÊäò„Çä„Åü„Åü„ÅøÔºâ -->
            <section id="us-comments-<%= t.id %>" class="us-comments is-collapsed" aria-hidden="true">
              <div class="us-comments__wrap">
                <h5 class="us-comments__ttl">„Ç≥„É°„É≥„Éà</h5>

                <% if t.comments.any? %>
                  <ul class="us-comments__list">
                    <% t.comments.each do |comment| %>
                      <li class="us-comment">
                        <div class="us-comment__head">
                          <span class="us-comment__name"><%= comment.user.name %></span>
                          <time class="us-comment__time"><%= comment.created_at.strftime('%m/%d %H:%M') %></time>
                        </div>
                        <div class="us-comment__body"><%= comment.content %></div>
                      </li>
                    <% end %>
                  </ul>
                <% else %>
                  <p class="us-comments__empty">„Åæ„Å†„Ç≥„É°„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                <% end %>
              </div>


            </section>
          </div>

          <% end %>
        
        </section>
      <% end %>
    </section>

    <!-- ÁîªÂÉè„É¢„Éº„ÉÄ„É´ÔºàÊó¢Â≠ò„ÅÆ‰ªïÁµÑ„Åø„ÇíÁ∂ôÁ∂öÔºâ -->
    <div id="image-modal" class="modal"><img id="modal-image" src=""></div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // ÁîªÂÉè„É¢„Éº„ÉÄ„É´
    const modal = document.getElementById("image-modal");
    const modalImg = document.getElementById("modal-image");
    document.querySelectorAll(".user-show-page .clickable-image").forEach(img => {
      img.addEventListener("click", () => {
        modalImg.src = img.dataset.fullImageUrl;
        modal.classList.add("open");
      });
    });
    modal.addEventListener("click", () => { modal.classList.remove("open"); modalImg.src = ""; });

    // „Ç≥„É°„É≥„ÉàÈñãÈñâ
    document.querySelectorAll(".user-show-page .us-comments__toggle").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-target");
        const section = document.getElementById(id);
        const expanded = btn.getAttribute("aria-expanded") === "true";
        btn.setAttribute("aria-expanded", String(!expanded));
        section.setAttribute("aria-hidden", String(expanded));
        section.classList.toggle("is-collapsed", expanded);
        section.classList.toggle("is-expanded", !expanded);
      });
    });

    // „Ç≥„É°„É≥„Éà„ÉÅ„ÉÉ„Éó
    document.querySelectorAll(".user-show-page .us-chip").forEach(chip => {
      chip.addEventListener("click", (e) => {
        const textarea = e.target.closest(".us-form").querySelector(".us-input");
        const insert = e.target.getAttribute("data-insert") || "";
        const v = textarea.value;
        textarea.value = v ? (v + " " + insert) : insert;
        textarea.focus();
      });
    });

    // „É™„ÉÉ„Éó„É´
    document.querySelectorAll('.user-show-page [data-ripple]').forEach(el => {
      el.addEventListener('click', function (e) {
        const r = document.createElement('span');
        r.className = 'ripple';
        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        r.style.width = r.style.height = size + 'px';
        r.style.left = (e.clientX - rect.left - size/2) + 'px';
        r.style.top  = (e.clientY - rect.top  - size/2) + 'px';
        this.appendChild(r);
        setTimeout(() => r.remove(), 500);
      });
    });
  });
</script>
